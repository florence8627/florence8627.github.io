<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />

    <style type="text/css">
        html { height: 100%; overflow:hidden;}
        body { height: 100%; margin: 0; padding: 0 }
        #map-canvas { height: 95% }
        .leaflet-overlay-pane svg path{
         pointer-events: auto;
         }

    </style>
    <!-- <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css" /> -->
    <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css' rel='stylesheet' />
    <link href="leaflet-rotate.css" rel="stylesheet" type="text/css"/>
    <link href="style.css" rel="stylesheet" type="text/css"/>

</head>
<body>
  <div id="map-canvas"></div>
  <div id="time">
  <svg id="slidersvg"></svg>
  </div>
  </div>
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.4.0/leaflet.js"></script> -->
<script src="leaflet-rotate.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.4.9/d3.min.js"></script>
<script src="L.D3SvgOverlay.min.js"></script>
<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>
<link rel="stylesheet" type="text/css" href="https://cdn.rawgit.com/gokertanrisever/leaflet-ruler/master/src/leaflet-ruler.css">
<script src="https://cdn.rawgit.com/gokertanrisever/leaflet-ruler/master/src/leaflet-ruler.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
<script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>
<script>
// map box tile layer
var tiles_dark = L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
    id: 'mapbox.dark',
    maxZoom:30,
    accessToken: 'pk.eyJ1IjoiZmxvcmVuY2U4NjI3IiwiYSI6ImNqb294Mmk1MTAzcGQzcG14cXpqZHh1YmMifQ.ahUeysh9RSQJ4jegcGrr4w'
});

var tiles_satellite = L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
    id: 'mapbox.streets-satellite',
    maxZoom:30,
    accessToken: 'pk.eyJ1IjoiZmxvcmVuY2U4NjI3IiwiYSI6ImNqb294Mmk1MTAzcGQzcG14cXpqZHh1YmMifQ.ahUeysh9RSQJ4jegcGrr4w'
});

var bearing = 0;
var map = L.map("map-canvas", {
	center: [-37.9109, 145.1344], 
	zoom: 17,
	minZoom: 10,
	maxZoom: 30,
    touchZoom: false,
    zoomSnap: 0.0,
    zoomDelta:0.1,
    rotate:true,
    touchRotate:false,
    doubleClickZoom:false,
    layers: [tiles_satellite,tiles_dark]
});


//adding pattern definition
d3.select("svg").append('defs').append("pattern")
                               .attr({id:"diagonal-stripe-3",patternUnits:"userSpaceOnUse",width:"5",height:"5"})
                               .append('path')
							    .attr('d', 'M-1,1 l2,-2 M0,4 l4,-4 M3,5 l2,-2')
							    .attr('stroke', '#000000')
							    .attr('stroke-width', 0.2)
							    .attr('fill','none');
var buildings = [];
var buildingsOverlay = L.d3SvgOverlay(function(sel, proj) {
	
var upd = sel.selectAll('path').data(buildings);
  

  upd.enter()
    .append('path')
    .filter(function(d){return d.properties.phase_1 == 'yes'})
    .attr("id", function (d) {return d.properties.name})
    .attr('d', proj.pathFromGeojson)   
    .attr('fill', "white")
    .attr('fill-opacity', '1')
    .attr('stroke', "orange")
    .attr('stroke-width', 1 / proj.scale)
    // .append("title")
    // .text(function(d){return d.properties.name});


  upd.enter()
     .append('path')
     .filter(function(d){return d.properties.phase_1!='yes'})
     .attr("id", function (d) {return d.properties.name})
     .attr('d', proj.pathFromGeojson)   
     .attr('fill', "black")
     .attr("fill-opacity","0.1")
     .attr('stroke-width', 1 / proj.scale)
     // .append("title")
     // .text(function(d){return d.properties.name});

   
    
});

var baseMaps = {"Satelite":tiles_satellite, "Symbolic": tiles_dark};
var overlayMaps = {"Buildings": buildingsOverlay};
L.control.layers(baseMaps, overlayMaps).addTo(map);
L.control.scale().addTo(map);
map.addControl(new L.Control.Fullscreen());
var options = {
	lengthUnit:{
		factor: 1000,
		decimal: 2,
		display:'meters',
		label:'Distance'
	}
}
L.control.ruler(options).addTo(map);
// adding rotation control
L.easyButton('<img src="images//rotation.png">', function(btn, map){
    bearing = bearing-1.5;
    map.setBearing(bearing);
}).addTo( map );
// adding weather control
L.easyButton('<img src="images//weather.png">', function(btn,map){

}).addTo(map);


d3.json("features-edit.geojson", function(data) { 
  buildings= data.features; 
  //console.log(buildings);
  buildingsOverlay.addTo(map) 
});

var width = document.getElementById('map-canvas').offsetWidth;
//console.log(width);
var x = d3.scale.linear().domain([6,17]).range([0, width-50]).clamp(true);
var brush = d3.svg.brush().x(x).extent([0, 0]);
 
var slider = d3.select("#slidersvg").attr("width", width).attr("height", 40).append("g").attr("class", "slider").attr("transform","translate(20,10)");
var classflow = slider.append("g").attr("class","classflow");
slider.append("g").attr("class", "x axis").call(d3.svg.axis().scale(x).orient("bottom")
      .tickFormat(function(d) { if (d<=12){return "2016-"+d;}
                                if (d> 12){return "2017-"+(d-12);} } )
      .ticks(12)
      .tickSize(0)
      .tickPadding(12))
      .select(".domain")
      .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
      .attr("class", "halo");
var handle = slider.append("circle").attr("class", "handle").attr("r", 10);


d3.csv("consump_all.csv", function(data){
   

    brush.on("brush", function(){
                  var value = brush.extent()[0];

            if (d3.event.sourceEvent) { // not a programmatic event
              value = x.invert(d3.mouse(this)[0]);
              brush.extent([value, value]);
              }

            handle.attr("cx", x(value));
            var month = Math.round(value);

            // console.log(month);
            // console.log(data[month-5]["Building_5"]);

            building_no = [1,10,11,12,15,16,17,18,19,2,20,21,22,23,24,25,26,27,28,29,30,31,32,33,35,36,37,38,4,40,41,42,43,44,45,46,47,48,5,53,54,56,59,6,61,62,63,64,67,68,69,7,70,72,73,74,75,76,77,8,81,82,84,85,86,87,88,89,9,90];
            for (i=0; i<building_no.length;i++){
	           max_value = d3.max(data.map(function(d){return d["Building_"+building_no[i]]}));
	           min_value = d3.min(data.map(function(d){return d["Building_"+building_no[i]]}));        
              
               d3.select("#building_"+building_no[i]).attr("fill", colorcode(data[month-6]["Building_"+building_no[i]],0, 1900000));
                


            }
            
                 
                 
              
             });
    
  slider.call(brush);
});

//slider animation introduction
slider.call(brush.event).transition().delay(20).duration(10000).call(brush.extent([17, 17])).call(brush.event);

function colorcode(Consumption, min, max){
   //console.log(Consumption);
  if (Consumption== -1){
  	
  	return "rgb(0.9,0.9,0.9)";
  }
  if(Consumption!=-1){
      var hue = 0.5-((Consumption-min)/(max-min))*0.5;
	  rgb_color = HSVtoRGB(hue,1,1);
	  //console.log(Consumption);
	  return "rgb("+rgb_color.r+","+rgb_color.g+","+rgb_color.b+")";
  }
}
function HSVtoRGB(h, s, v) {
    var r, g, b, i, f, p, q, t;
    if (arguments.length === 1) {
        s = h.s, v = h.v, h = h.h;
    }
    i = Math.floor(h * 6);
    f = h * 6 - i;
    p = v * (1 - s);
    q = v * (1 - f * s);
    t = v * (1 - (1 - f) * s);
    switch (i % 6) {
        case 0: r = v, g = t, b = p; break;
        case 1: r = q, g = v, b = p; break;
        case 2: r = p, g = v, b = t; break;
        case 3: r = p, g = q, b = v; break;
        case 4: r = t, g = p, b = v; break;
        case 5: r = v, g = p, b = q; break;
    }
    return {
        r: Math.round(r * 255),
        g: Math.round(g * 255),
        b: Math.round(b * 255)
    };
}
</script>
    
</body>
</html>